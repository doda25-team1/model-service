name: Train & Release Model

on:
  workflow_dispatch:
    inputs:
      model_version:
        description: "Model version (e.g. 1.0.0)"
        required: true

permissions:
  contents: write

jobs:
  train-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Preprocess data
        run: |
          mkdir -p output
          python src/text_preprocessing.py

      - name: Train model
        run: |
          mkdir -p output
          python src/text_classification.py \
            --model-version "${{ github.event.inputs.model_version }}"

      # GitHub CLI is preinstalled on all GitHub-hosted runners
      - name: Create tag and GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ github.event.inputs.model_version }}
        run: |
          set -e
          TAG="model-v${VERSION}"

          git fetch --tags

          # Create tag if doesn't exist
          if ! git rev-parse "$TAG" >/dev/null 2>&1; then
            git tag "$TAG"
            git push origin "$TAG"
          else
            echo "Tag $TAG already exists"
          fi

          # Create release if doesn't exist
          if ! gh release view "$TAG" >/dev/null 2>&1; then
            gh release create "$TAG" \
              --title "Model ${VERSION}" \
              --notes "Trained spam classifier model version ${VERSION}"
          else
            echo "Release $TAG already exists"
          fi

      - name: Upload model artifacts to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ github.event.inputs.model_version }}
        run: |
          TAG="model-v${VERSION}"

          [ -f "output/model-${VERSION}.joblib" ] || { echo "Missing model file"; exit 1; }
          [ -f output/preprocessor.joblib ] || { echo "Missing preprocessor.joblib"; exit 1; }
          [ -f output/preprocessed_data.joblib ] || { echo "Missing preprocessed_data.joblib"; exit 1; }

          gh release upload "$TAG" "output/model-${VERSION}.joblib" --clobber
          gh release upload "$TAG" output/preprocessor.joblib --clobber
          gh release upload "$TAG" output/preprocessed_data.joblib --clobber
